#!/usr/bin/env python3
#coding=utf8

from dex import DexFile

if __name__ == '__main__':
	import sys
	df = DexFile(sys.argv[1])
	blocks = df.getfunc(*sys.argv[2:5])

	print('digraph {')

	# first, print all nodes
	for block in blocks:
		attrs = {}
		attrs['shape'] = 'box'
		if block.ops:
			ins = zip(block.addrs, block.ops, block.args)
			ins = '\\n'.join('%04x: %-20s %s' % x for x in ins)
			attrs['label'] = block.name + '\\n' + ins.replace('"', '\\"')
		attrs = ','.join('%s="%s"' % item for item in attrs.items())
		print(block.name, '[%s]' % attrs)

	# then, all the edges
	for block in blocks:
		assert block.succ is not None
		for cond, target in block.succ.items():
			attrs = {}
			if type(cond) is int:
				attrs['color'] = '#33cc00'
				# TODO: use value as edge label
			elif cond is True:
				attrs['color'] = '#00cc00'
			attrs = ','.join('%s="%s"' % item for item in attrs.items())
			print(block.name, '->', target.name, '[%s]' % attrs)
		# TODO: catches!

	print('}')
